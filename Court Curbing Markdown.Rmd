---
title: "Court Curb Analysis"
author: "Richard G. Gardiner"
date: "10/24/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Next steps




# Summary



# Ideas



# Questions

* The percentages object potentially has a denominator problem (small n, wild differences based off of one change)

# Reading in Data
```{r, packages, message=FALSE}
library(tidyverse)
library(readxl)
library(grid)
library(gridExtra)
```

This section reads in the relevant data I have collected as well as joins some additional datasets to get political culture and and legislative control.
```{r, reading_in_data, message = FALSE}
gavelFull <- read_excel("Gavel to Gavel dataset.xlsx")
politicalCulture <- read_csv("political culture.csv")
legislativeControl <- read_excel("Legislative Control.xlsx")

```

Now I join the full gavel-to-gavel dataset with the political culture and test to make sure that there is no problem of "full rank"
```{r}
gavelWithCulture <- left_join(gavelFull, politicalCulture, 
                               by = c("Fullstate" = "State"))

table(gavelWithCulture$Moralistic, gavelWithCulture$Traditionalistic)
```

The same process, with this one being legislative control.
```{r}
gavelCultureControl <- left_join(gavelWithCulture, legislativeControl,
                                 by = c("Fullstate" = "State", "Year" = "Year"))

table(gavelCultureControl$RepublicanLegslature, gavelCultureControl$SplitLegislature)
```

Here I am changing the control variables from strings into numerics to allow for modeling.
```{r}
gavelCultureControl$Culture <- ifelse(gavelCultureControl$Moralistic == 1, "Moralistic", 
                                      ifelse(gavelCultureControl$Traditionalistic == 1, "Traditionalistic",
                                             "Individualistic"))
table(gavelCultureControl$Culture, gavelCultureControl$Culture)

gavelCultureControl$legislativeControl <- ifelse(gavelCultureControl$SplitLegislature == 1, "0", 
                                                 ifelse(gavelCultureControl$SplitLegislature == 1, "Split",
                                                        "Democratic"))

gavelCultureControl$unified <- ifelse(gavelCultureControl$SplitLegislature == 0, 1, 0)
table(gavelCultureControl$legislativeControl, gavelCultureControl$unified)
```

# Initial Analysis

First graph.  This analyses each row and sees how many rows have curbs compared to legislation that does not curb courts.  While we do see a little variation between the different cultures, my guess is that almost all of the variation occurs because of raw numbers.
```{r, curbs_by_culture}
ggplot(data = subset(gavelCultureControl, !is.na(gavelCultureControl$Culture))) +
  geom_bar(aes(x = curbing)) +
  facet_wrap(~Culture)


table(gavelCultureControl$curbing)
```

As with the graph, we see that Traditionalistic states have slightly higher rates of curbing than Moralistic and Individualistic is the lowest. Still not convinced that there is a real relationship occuring.
```{r}
gavelCultureControl %>%
  group_by(Culture) %>%
  filter(!is.na(Culture)) %>%
  filter(!is.na(curbing)) %>%
  summarise(mean = mean(curbing))
```

Trying to see bill outcomes for all legislation. 
```{r}
table(gavelCultureControl$legislativeControl, gavelCultureControl$RichardLastAction)
```

Running the same code, but creating a new object in which only curbing legislation is included.  Republican legislatures have a significant more in every category.  There are certainly more instances of Republican control, but this one may be significant enough.  Interestingly, though, is that Democratic legislatures have more enacted legislation.
```{r}
gavelCultureControlOnlyCurbs <- gavelCultureControl %>%
  filter(curbing == 1) 
  
table(gavelCultureControlOnlyCurbs$legislativeControl, gavelCultureControlOnlyCurbs$RichardLastAction)
```

The last outcome did make me want to look at years and how many instances Democrats controlled the state legislature compared to Republicans.  Republicans are in power more often, but a rather small gap compared to the amount of legislation.  Results: Republican is 241 instances, Democratic is 221, and Split is 76
```{r}
table(legislativeControl$RepublicanLegslature, legislativeControl$SplitLegislature)
```

Drilling down into the data, I now look at proportions for legislation that is introduced and then enacted:
```{r}
# republican controlled legislatures introduced court curbing bills 16.7 times a year, 18.6 for democratically controlled, and split had 11.97 
introduced <- c(3702/221, 4483/241, 910/76)
introduced 

# enacted legislation proportion
enacted <- c(197/3702, 185/4483, 46/910)
enacted
```

## Calculating Distance From Each Branch

As Dr. Steigerwalt suggested, rather than making a complex ideological distance measure with all three branches, I am creating a separate variable for ideological distance for the court and each actor (Governor, lower chamber, upper chamber).  These are simply taking the absolute difference between the branches then graphing to get a better idea.
```{r}
gavelCultureControl$court_gov_dist <- abs(gavelCultureControl$judicial - gavelCultureControl$governor)
gavelCultureControl$court_lower_dist <- abs(gavelCultureControl$judicial - gavelCultureControl$lower)
gavelCultureControl$court_upper_dist <- abs(gavelCultureControl$judicial - gavelCultureControl$upper)
```

The graphs below (which are eventually put into one grid) show the ideological distance for each relationship broken down by selection
```{r, ideological_distance_graphs, collapse = TRUE}
a <- ggplot(data = gavelCultureControl) +
  geom_boxplot(aes(x = MoreDefined, y = court_gov_dist)) +
  xlab(NULL) +
  ylab("Court - Governor")
b <- ggplot(data = gavelCultureControl) +
  geom_boxplot(aes(x = MoreDefined, y = court_lower_dist)) +
  xlab(NULL) +
  ylab("Court - Lower")
c <- ggplot(data = gavelCultureControl) +
  geom_boxplot(aes(x = MoreDefined, y = court_upper_dist)) +
  xlab("Selection System") +
  ylab("Court - Upper")

grid.arrange(a,b,c)
```


## Creating objects with time and average ideological distance
```{r, ideological_distance_over_time, collapse = TRUE}
ideology_gov_year <- gavelCultureControl %>% 
  group_by(MoreDefined, Year) %>%
  filter(!is.na(court_gov_dist)) %>%
  summarise(govMean = mean(court_gov_dist)) %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) # filtering out bad data


ideology_upper_year <- gavelCultureControl %>% 
  group_by(MoreDefined, Year) %>%
  filter(!is.na(court_upper_dist)) %>%
  summarise(upperMean = mean(court_upper_dist)) %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) # filtering out bad data
  
ideology_lower_year <- gavelCultureControl %>% 
  group_by(MoreDefined, Year) %>%
  filter(!is.na(court_lower_dist)) %>%
  summarise(lowerMean = mean(court_lower_dist)) %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) # filtering out bad data

## graphing the data
d <- ggplot(data = ideology_gov_year) +
  geom_line(aes(x = Year, y = govMean, color = MoreDefined)) +
  scale_x_continuous(breaks = c(2008, 2009, 2010, 2011, 2012)) +
  xlab(NULL) +
  ylab("Mean: Court - Governor") +
  labs(colour = "Selection")

e <- ggplot(data = ideology_upper_year) +
  geom_line(aes(x = Year, y = upperMean, color = MoreDefined)) +
  scale_x_continuous(breaks = c(2008, 2009, 2010, 2011, 2012)) +
  xlab(NULL) +
  ylab("Mean: Court - Upper") +
  labs(colour = "Selection")

f <- ggplot(data = ideology_lower_year) +
  geom_line(aes(x = Year, y = lowerMean, color = MoreDefined)) +
  scale_x_continuous(breaks = c(2008, 2009, 2010, 2011, 2012)) +
  xlab(NULL) +
  ylab("Mean: Court - Lower") +
  labs(colour = "Selection")

# retention continues to be at teh high end of the list
grid.arrange(d,e,f)
```



### Graphing the Relationship between ideologicaly distance and court curbing

The code below creates scatter plots that show the relationship between ideological distance and court curbing legislation.  Note the difference in scales!  Unsurprisingly, there appears to be the weakest relationship between curbs and ideological distance between the Court and Governor. 
```{r}
g <- gavelCultureControl %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) %>% # filtering out bad data
  group_by(Fullstate) %>%
  filter(!is.na(court_lower_dist)) %>%
  summarise(sum = sum(curbing),
            avg_ideology = mean(court_lower_dist)) %>%
  ggplot() +
  geom_point(aes(x = avg_ideology, y = sum)) +
  ylab(NULL) +
  xlab("Court and Lower Chamber") 


h <- gavelCultureControl %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) %>% # filtering out bad data
  group_by(Fullstate) %>%
  filter(!is.na(court_upper_dist)) %>%
  summarise(sum = sum(curbing),
            avg_ideology = mean(court_upper_dist)) %>%
  ggplot() +
  geom_point(aes(x = avg_ideology, y = sum)) +
  ylab("Court Curbing Introductions") +
  xlab("Court and Upper Chamber")

i <- gavelCultureControl %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) %>% # filtering out bad data
  group_by(Fullstate) %>%
  filter(!is.na(court_gov_dist)) %>%
  summarise(sum = sum(curbing),
            avg_ideology = mean(court_gov_dist)) %>%
  ggplot() +
  geom_point(aes(x = avg_ideology, y = sum)) +
  ylab(NULL) +
  xlab("Court and Governor") 
  
grid.arrange(g, h, i)
```

The last chart deserves further exploration.  I decided to also run the last plot, but this time only including enacted legislation.  With the note that this is limited in the number of observations, I decided to graph it.  The results still show really no relationship between ideological distance and curbs.
```{r}
gavelCultureControl %>%
  group_by(Fullstate) %>%
  filter(!is.na(court_gov_dist)) %>%
  filter(RichardLastAction == "Enacted") %>%
  summarise(sum = sum(curbing),
            avg_ideology = mean(court_gov_dist)) %>%
  ggplot() +
  geom_point(aes(x = avg_ideology, y = sum)) +
  ylab(NULL) +
  xlab("Court and Governor") +
  geom_smooth(aes(x = avg_ideology, y = sum))
```


# Model Prep

In order to run a count model, I determined that I needed to have one row per state-year combination.  This required a number of tries, but it appears to have finally worked using the following code (though see question section below for more detail).
```{r}
count_data <- gavelCultureControl %>%
  filter(!(Year %in% c("2007", "43147"))) %>% # filtering out bad data
  group_by(State, Year) %>% 
  mutate(curbs = sum(curbing)) %>%
  distinct(State, Year, .keep_all = TRUE) %>%
  arrange(State, Year) 
  
count_data
```



Now I am adding in new "elected" variable as well as making columns for each election system broken down.  This really should have happened earlier, but better late than never.
```{r}
count_data$elected <- ifelse(count_data$Elected == "Elected", 1, 0)
count_data$partisan <- ifelse(count_data$MoreDefined == "Partisan", 1, 0)
count_data$nonpartisan <- ifelse(count_data$MoreDefined == "Nonpartisan", 1, 0)
count_data$retention <- ifelse(count_data$MoreDefined == "Retention", 1, 0)
```


### Interacting Ideology and selection system

```{r}
count_data$elected_ideology_gov <- count_data$elected * count_data$court_gov_dist
count_data$elected_ideology_upper <- count_data$elected * count_data$court_upper_dist
count_data$elected_ideology_lower <- count_data$elected * count_data$court_lower_dist

count_data$partisan_ideology_gov <- count_data$partisan * count_data$court_gov_dist
count_data$partisan_ideology_upper <- count_data$partisan * count_data$court_upper_dist
count_data$partisan_ideology_lower <- count_data$partisan * count_data$court_lower_dist

count_data$nonpartisan_ideology_gov <- count_data$nonpartisan * count_data$court_gov_dist
count_data$nonpartisan_ideology_upper <- count_data$nonpartisan * count_data$court_upper_dist
count_data$nonpartisan_ideology_lower <- count_data$nonpartisan * count_data$court_lower_dist

count_data$retention_ideology_gov <- count_data$retention * count_data$court_gov_dist
count_data$retention_ideology_upper <- count_data$retention * count_data$court_upper_dist
count_data$retention_ideology_lower <- count_data$retention * count_data$court_lower_dist

summary(count_data$elected_ideology_gov)
count_data$elected
count_data$court_gov_dist
```

### Adding in Legislative Professionalization

```{r}
professionalization <- read_csv("ncsl professionalization.csv")
str(professionalization)
count_data <- left_join(count_data, professionalization, by = c("Fullstate" = "State"))

# quick vizualization to check the data
ggplot(data = count_data) +
  geom_bar(aes(Professionalization))
```

I want to run another vizualization to test the data.
```{r}
ggplot(data = count_data) +
  geom_boxplot(aes(x = Professionalization, y = curbs, colour = Professionalization), show.legend = FALSE) +
  ylab("Number of Curbs") +
  xlab("Level of Professionalization \n(Lowest to Highest)")
```

## Last Data Cleaning

After meeting with Steigerwalt, I have decided to drop all observations where the legislature has not met.  This is primarily made up of astates that meet every other year.  To do this, I added dummy observations for the few instances where there was no legislation concerning courts that year.  

```{r}
table(count_data$Year, count_data$Fullstate)
```
This table shows the states for which there are no observations that year because they did not meet. The following table shows the number of instances for each state where I had to include dummy variables.

```{r}
table(gavelFull$Description == "No Legislation", gavelFull$State)
```

# Iniital Models

```{r}
curbs.poisson <- glm(curbs ~ Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature + court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + court_gov_dist + court_lower_dist + court_upper_dist + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper + Professionalization,
                     family = poisson(link = log),
                     data = count_data)

summary(curbs.poisson)

exp(-0.675867) # need exponent to be able to make a good interpreptation.
# this one, for example, shows us that (for the goefficient on retention elections) that by switching between appointed to retention we see about a 49% drop in curbs

exp(curbs.poisson$coefficients[-1])
```

Now I will run a Negative Binomial model to check to see how this model compares and to see if there is a problem of overdispersion in the poisson

```{r}
library(MASS)

curbs1.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature + court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + court_gov_dist + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper + Professionalization,
                     data = count_data)

summary(curbs1.nb)
```

The Theta parameter (with the accompanying standard error) tells us that overdispersion is present and thus we should not be using a poisson model.  The Negative Binomial also has a lower AIC than the poisson giving even more evidence that the negaitve binomial is the better model.

I forgot until now that I want to remove the governor from the model that looks at all bills because they are not really in the calculation for this.  The code below is a new model excluding the governor.

```{r}
curbs2.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature + court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper + Professionalization,
                     data = count_data)

summary(curbs2.nb)
```


```{r}
library(modelr)

grid <- count_data %>%
  data_grid(retention_ideology_upper, .model = curbs2.nb) %>%
  add_predictions(curbs2.nb)
  

grid

ggplot(grid, aes(retention_ideology_upper, pred)) +
  geom_point()
```

```{r}
curbs2.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature + court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper + Professionalization,
                     data = count_data)

summary(curbs2.nb)
```

# Variations 

```{r}
# bare bones model: 
curbs3.nb <- glm.nb(curbs ~ retention + partisan + nonpartisan,
                     data = count_data)
summary(curbs3.nb)
```

```{r}
curbs4.nb <- glm.nb(curbs ~ court_lower_dist + court_upper_dist + retention + partisan + nonpartisan,
                     data = count_data)
summary(curbs4.nb)
```

```{r}
curbs5.nb <- glm.nb(curbs ~ court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper,
                     data = count_data)
summary(curbs5.nb)
```

### Elected and Appointed 

This section is looking at elected and appointed versus the broken down variable (with variations).  First, I need to create a variable that can capture elected versus appointed

```{r}
curbs.elected.nb <- glm.nb(curbs ~ elected,
                     data = count_data)
summary(curbs.elected.nb) # not significant
```

```{r}
curbs.elected1.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist,
                     data = count_data)
summary(curbs.elected1.nb) # again, the upper house ideological distance variable is significant
```

```{r}
curbs.elected2.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist + elected_ideology_lower + elected_ideology_upper,
                     data = count_data)
summary(curbs.elected2.nb) # upper is significant still
```

```{r}
curbs.elected3.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist + elected_ideology_lower + elected_ideology_upper + Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature +  Professionalization,
                     data = count_data)
summary(curbs.elected3.nb)
```


### Up until 2012 data (problems with ideology)

Getting data without the other years
```{r}
count_data2 <- gavelCultureControl %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018"))) %>% # filtering out bad data
  group_by(State, Year) %>% 
  mutate(curbs = sum(curbing)) %>%
  distinct(State, Year, .keep_all = TRUE) %>%
  arrange(State, Year) 
  
count_data2
```

Adding in new variables
```{r}
count_data2$elected <- ifelse(count_data2$Elected == "Elected", 1, 0)
count_data2$partisan <- ifelse(count_data2$MoreDefined == "Partisan", 1, 0)
count_data2$nonpartisan <- ifelse(count_data2$MoreDefined == "Nonpartisan", 1, 0)
count_data2$retention <- ifelse(count_data2$MoreDefined == "Retention", 1, 0)

count_data2$elected_ideology_gov <- count_data2$elected * count_data2$court_gov_dist
count_data2$elected_ideology_upper <- count_data2$elected * count_data2$court_upper_dist
count_data2$elected_ideology_lower <- count_data2$elected * count_data2$court_lower_dist

count_data2$partisan_ideology_gov <- count_data2$partisan * count_data2$court_gov_dist
count_data2$partisan_ideology_upper <- count_data2$partisan * count_data2$court_upper_dist
count_data2$partisan_ideology_lower <- count_data2$partisan * count_data2$court_lower_dist

count_data2$nonpartisan_ideology_gov <- count_data2$nonpartisan * count_data2$court_gov_dist
count_data2$nonpartisan_ideology_upper <- count_data2$nonpartisan * count_data2$court_upper_dist
count_data2$nonpartisan_ideology_lower <- count_data2$nonpartisan * count_data2$court_lower_dist

count_data2$retention_ideology_gov <- count_data2$retention * count_data2$court_gov_dist
count_data2$retention_ideology_upper <- count_data2$retention * count_data2$court_upper_dist
count_data2$retention_ideology_lower <- count_data2$retention * count_data2$court_lower_dist

count_data2 <- left_join(count_data2, professionalization, by = c("Fullstate" = "State"))

table(count_data2$Year, count_data2$Fullstate)
```

```{r}
curbs_2.nb <- glm.nb(curbs ~ retention + partisan + nonpartisan,
                     data = count_data2)
summary(curbs_2.nb) # nothing significant
```

```{r}
curbs2.elected1.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist,
                     data = count_data2)
summary(curbs2.elected1.nb) # upper distance is again distinct
```

```{r}
curbs2.elected2.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist + elected_ideology_lower + elected_ideology_upper,
                     data = count_data2)
summary(curbs2.elected2.nb) # nothing significant
```

```{r}
curbs2.elected3.nb <- glm.nb(curbs ~ elected + court_upper_dist + court_lower_dist + elected_ideology_lower + elected_ideology_upper + Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature +  Professionalization,
                     data = count_data2)
summary(curbs2.elected3.nb)
```

```{r}
curbs2_full.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + RepublicanLegslature + SplitLegislature + court_lower_dist + court_upper_dist + retention + partisan + nonpartisan + partisan_ideology_upper + partisan_ideology_lower + nonpartisan_ideology_upper + nonpartisan_ideology_lower + retention_ideology_lower + retention_ideology_upper + Professionalization,
                     data = count_data2)

summary(curbs2_full.nb) # none of my important variables are predictive
```


# Post-Steigerwalt Meeting (End of November 2018)

Suggestions from Steigerwalt:

* What percentage of all legislation that year that deal with courts are court curbing bills (4 court curbing out of 20 bills)?  Run a regression with that
* Do unified/divided instead of the republican/democratic/split
* map out upper and partisan interaction (plot it out).  This applies, right now, to the count models
* Question: is the full model overfitted?

## Doing Unified government

Full model
```{r}
curbs_unified.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + unified + court_lower_dist + court_upper_dist + elected + elected_ideology_upper + elected_ideology_lower + Professionalization,
                     data = count_data2)

summary(curbs_unified.nb) # traditionalistic, professionalization, and unified are significant and positive.
```


## Percentage of all legislation that year
```{r}
percent_curbing <- gavelCultureControl %>%
  group_by(Fullstate, Year) %>%
  summarise(percentage = sum(curbing)/n()) 
  
percent_curbing <- percent_curbing %>%
  left_join(count_data, by = c("Fullstate", "Year")) %>%
  dplyr::select(-5:-6, -9:-17) 

percent_curbing
```

One of the first things I notice is that Alaska in 2017 has a score of 1, but that is really only because in 2017 there is only one bill that is dealing with the courts and that is a curbing bill.  How should that really be counted?  It feels like there should be some kind of weighting measure, but will have to discuss with Steigerwalt.
```{r}
gavelCultureControl %>%
  filter(Fullstate == "Alaska" & Year == 2017)
```



It appears, from the graph below, that there is a slight difference in the means between the two.  A simple t-test should show us that.
```{r}
percent_curbing %>%
  filter(!is.na(Elected)) %>%
  ggplot() +
    geom_histogram(aes(percentage, y = ..density.., fill = Elected)) +
    facet_wrap(~ Elected)
```


A simple t-test shows that there is a statistically significant differnece between the two and that the mean of Elected states is significantly higher than the mean of appointed courts.
```{r}
t.test(percentage ~ Elected, data = percent_curbing)
```

Now let's try a simple linear model:

```{r}
percent_md <- lm(percentage ~ Elected, data = percent_curbing)
summary(percent_md)
```

Now we are starting to get some significance.  Let's start with some more variables and see what happens

```{r}
percent_md_1 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist, 
                    data = percent_curbing)
summary(percent_md_1) # elected is still significant and positive
```

Adding in interaction terms
```{r}
percent_md_2 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower, 
                    data = percent_curbing)

summary(percent_md_2) # elected is still positive and significant.  Nothing else is close
```
Adding in political culture
```{r}
percent_md_3 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower +
                     Moralistic + Traditionalistic, 
                    data = percent_curbing)
summary(percent_md_3) # election is still positive and significant.  Nothing else is. 
```

adding in professionalization
```{r}
percent_md_4 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower +
                     Moralistic + Traditionalistic + Professionalization, 
                    data = percent_curbing)

summary(percent_md_4) # elected is positive and significant.  Professionalization is positive and significant
```

adding in unified government.  This would constitute the full model
```{r}
percent_curbing <- percent_curbing %>%
  mutate(unified = ifelse(SplitLegislature == 0, 1, 0))

percent_md_5 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower +
                     Moralistic + Traditionalistic + Professionalization + unified, 
                    data = percent_curbing)
summary(percent_md_5) # elected hangs on at the .1 significance level.  Traditionalistic is positive and sig at .1, professionalization is positive and sig at .1, unified is negative (DON'T KNOW WHY) and significant at .05.
```

Takeaway: Elected really is significant and robust to multiple variations.

```{r}
percent_curbing2 <- percent_curbing %>%
  filter(!is.na(Elected)) %>%
  filter(!(Year %in% c("2007", "43147", "2013", "2014", "2015", "2016", "2017", "2018")))  # filtering out bad data

percent_curbing2

percent_md_6 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower +
                     Moralistic + Traditionalistic + Professionalization + unified, 
                    data = percent_curbing2) # full model, not good

percent_md_7 <- lm(percentage ~ elected, 
                    data = percent_curbing2)
summary(percent_md_7)

percent_md_8 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist, 
                    data = percent_curbing2)
summary(percent_md_8)

percent_md_9 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower, 
                    data = percent_curbing2)
summary(percent_md_9) # nothing sig

percent_md_10 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower + Moralistic + Traditionalistic, 
                    data = percent_curbing2)
summary(percent_md_10) # nothing sig

percent_md_11 <- lm(percentage ~ elected + court_upper_dist + court_lower_dist + elected_ideology_upper + elected_ideology_lower + Moralistic + Traditionalistic + Professionalization, 
                    data = percent_curbing2) # professionalization is sig
summary(percent_md_11)
```


### takeaway

Using less data (fewer years), the model is no longer significant.  DO IDEOLOGY WITH FEWER YEARS (MORE PROPER), THEN DO FULLER MODELS WITHOUT IDEOLOGY.

# Final Models:

I will use these as the official models with the broken down models in an appendix.

## Final Models - Percentage DV
```{r}
## Shorter years
summary(percent_md_7) # just elected
summary(percent_md_8) # elected and ideology
summary(percent_md_9) # elected interacted with ideology nothing sig
summary(percent_md_6) # full model with ideology and shorter years


## Full years, no ideology
percent_md_no_id_1 <- lm(percentage ~ elected + Moralistic + Traditionalistic + Professionalization + unified, data = percent_curbing)
summary(percent_md_no_id_1) # full model (excluding ideology)

percent_md_no_id_2 <- lm(percentage ~ elected, data = percent_curbing)
summary(percent_md_no_id_2) # sig, by itself



```


### Predictions

```{r}
percent_curbing2_predictions <- percent_curbing2 %>%
  add_predictions(percent_md_6)

ggplot(data = percent_curbing2_predictions) +
  geom_boxplot(aes(x = as.factor(Professionalization), y = pred)) +
  xlab("Level of Professionalization") +
  ylab("Predicted Proportion")

ggplot(data = percent_curbing2_predictions) +
  geom_boxplot(aes(x = as.factor(elected), y = pred)) +
  ylab("Predicted Proportion") +
  xlab("Elected Versus Appointed") +
  scale_x_discrete(labels = c("0" = "Appointed", "1" = "Elected"))

j <- ggplot(data = percent_curbing2_predictions) +
  geom_point(aes(x = court_lower_dist, y = pred)) +
  ylab("Predicted Proportion") +
  xlab("Ideological Distance from Lower Chamber")

k <- ggplot(data = percent_curbing2_predictions) +
  geom_point(aes(x = court_upper_dist, y = pred)) +
  ylab("Predicted Proportion") +
  xlab("Ideological Distance from Upper Chamber")
  
grid.arrange(j, k)


## without ideology
percent_curbing_predictions <- percent_curbing %>%
  add_predictions(percent_md_no_id_1)

ggplot(data = percent_curbing_predictions) +
  geom_boxplot(aes(x = as.factor(Professionalization), y = pred)) +
  xlab("Level of Professionalization") +
  ylab("Predicted Proportion")


ggplot(data = percent_curbing_predictions) +
  geom_boxplot(aes(x = as.factor(elected), y = pred)) +
  xlab("Elected Versus Appointed") +
  ylab("Predicted Proportion") +
  scale_x_discrete(labels = c("0" = "Appointed", "1" = "Elected"))

```

## Final Models - Count

```{r}
# shorter years (with ideology included)
summary(curbs_unified.nb) # full model
exp(curbs_unified.nb$coefficients)


curbs2.elected0.nb <- glm.nb(curbs ~ elected, data = count_data2)
summary(curbs2.elected0.nb) # just elected

summary(curbs2.elected1.nb) # elected and ideology (no iteractions)
summary(curbs2.elected2.nb) # elected and ideology (interacted)

exp(curbs2.elected1.nb$coefficients)

# longer years (no ideology)
summary(curbs.elected.nb) # just elected

curbs.elected.unified.nb <- glm.nb(curbs ~ Moralistic + Traditionalistic + unified +  elected + Professionalization,
                     data = count_data)
summary(curbs.elected.unified.nb) # full model
exp(curbs.elected.unified.nb$coefficients)
```


### Adding predictions for Count Data

```{r}
count_data2_predictions <- count_data2 %>%
  add_predictions(curbs_unified.nb)

ggplot(data = count_data2_predictions) +
  geom_boxplot(aes(x = as.factor(Professionalization), y = pred)) +
  ylab("Predicted Count") +
  xlab("Level of Professionalization")

ggplot(data = count_data2_predictions) +
  geom_boxplot(aes(x = as.factor(elected), y = pred)) +
  ylab("Predicted Count") +
  xlab("Elected Versus Appointed") +
  scale_x_discrete(labels = c("0" = "Appointed", "1" = "Elected"))

l <- ggplot(data = count_data2_predictions) +
  geom_point(aes(x = court_lower_dist, y = pred)) +
  ylab("Predicted Count") +
  xlab("Ideological Distance from Lower Chamber")


m <- ggplot(data = count_data2_predictions) +
  geom_point(aes(x = court_upper_dist, y = pred)) +
  ylab("Predicted Count") +
  xlab("Ideological Distance from Upper Chamber")

grid.arrange(l, m)

grid <- count_data2 %>%
  data_grid(court_upper_dist, .model = curbs_unified.nb) %>%
  add_predictions(curbs_unified.nb)


ggplot(grid, aes(court_upper_dist, pred)) +
  geom_point() +
  ylab("Predicted Count") +
  xlab("Simulated Ideological Distance from Upper Chamber")


# Now without ideology 
count_data_predictions <- count_data %>%
  add_predictions(curbs.elected.unified.nb) 

# added jitter because it was so weird
ggplot(data = count_data_predictions) +
  geom_boxplot(aes(x = as.factor(Professionalization), y = pred)) +
  ylab("Predicted Count") +
  xlab("Level of Professinalization") +
  geom_jitter(aes(x = as.factor(Professionalization), y = pred))

ggplot(data = count_data_predictions) +
  geom_boxplot(aes(x = as.factor(elected), y = pred)) +
  ylab("Predicted Count") +
  xlab("Elected Versus Appointed") +
  scale_x_discrete(labels = c("0" = "Appointed", "1" = "Elected"))
  
```

## Model diagnostics

### No Ideology:
Adding the predicted and residual values
```{r}
percent_curbing  <- percent_curbing %>%
  filter(!is.na(Elected)) %>%
  add_predictions(percent_md_no_id_1) %>%
  add_residuals(percent_md_no_id_1) %>%
  filter(!is.na(resid))
```

Checking normal distribution.  It is pretty good, but there are some outliers at the far right.  The mean of the residual is: `r mean(percent_curbing$resid)` which is rather small. 
```{r}
ggplot(percent_curbing, aes(resid)) +
  geom_histogram()
```

```{r}
plot(percent_md_no_id_1)
```


### Shorter years, but ideology

```{r}
percent_curbing2  <- percent_curbing2 %>%
  filter(!is.na(Elected)) %>%
  add_predictions(percent_md_6) %>%
  add_residuals(percent_md_6) %>%
  filter(!is.na(resid))
```


Checking normal distribution.  It is pretty good, but there are some outliers at the far right.  The mean of the residual is: `r mean(percent_curbing2$resid)` which is rather small. 
```{r}
ggplot(percent_curbing2, aes(resid)) +
  geom_histogram()
```

```{r}
plot(percent_md_6)
```

It does struggle on the outer edges of X.


### Concerns with the proportion DV

I am worried that the proportion of all court curbing legislation in one year for a given state is so small that changing the numerator by 1 will produce wild swings.  Let's check this out:

```{r}
d <- ggplot(percent_curbing) +
  geom_histogram(aes(x = percentage, y = ..density..)) +
  labs(x = "Proportion of Bills that Curb Courts")
```

The chart above shows the distribution of proportions.  This is somewhat unsuripring in the distribution, but now lets look at the total number of legislation in a given year.

```{r}
bills_state_year <- gavelFull %>%
  group_by(Fullstate, Year) %>%
  count()
  
e <- ggplot(bills_state_year) +
  geom_histogram(aes(x = n, y = ..density..)) +
  labs(x = "Number of Bills in a Year")

gridExtra::grid.arrange(d, e, ncol = 2)
```

There graph shows that while there are instances of a large number of legislation concerning the court, the median is `r median(bills_state_year$n)` with a mode of 1.  


## Testing out the idea of splitting up the electoral variable

This is primarily in response to the poor showing of election.
```{r}
test <- glm.nb(curbs ~ Moralistic + Traditionalistic + unified +  partisan + nonpartisan + retention + Professionalization,
                     data = count_data)
summary(test)

test2 <- glm.nb(curbs ~ partisan + nonpartisan + retention,
                     data = count_data)
summary(test2)

```





# Additional EDA

This section is mainly present to get rid of the Tableau graphs


```{r}
gavelCultureControlOnlyCurbs %>%
  count(Year) %>%
  filter(Year > 2007) %>%
  mutate(Year = as.Date(as.character(Year), format = "%Y")) %>%
  ggplot(aes(x = Year, y = n)) +
  geom_line() +
  scale_x_date() +
  ylim(c(0,250)) +
  ylab("Total Number of Court Curing Legislation Introducted") +
  theme_light()

# ggsave("Curbs over time.jpeg")


gavelCultureControlOnlyCurbs %>%
  count(Type) %>%
  mutate(Type = fct_reorder(Type, n)) %>%
  ggplot(aes(Type, n)) +
  geom_bar(stat = "identity") +
  ylab("Number of Court Curbing Legislation Introduced") +
  coord_flip() +
  theme_light() 

# ggsave("curbs by type.jpeg")

gavelCultureControlOnlyCurbs %>%
  count(RichardLastAction) %>%
  mutate(RichardLastAction = fct_reorder(RichardLastAction, n)) %>%
  ggplot(aes(RichardLastAction, n)) +
  geom_bar(stat = "identity") +
  ylab("Number of Bills") +
  xlab("Final Outcome") +
  coord_flip() +
  theme_light()

# ggsave("curbs by final outcome.jpeg")

gavelCultureControlOnlyCurbs %>%
  group_by(Fullstate, MoreDefined, Year) %>%
  summarize(total_curbs = sum(curbing)) %>%
  ungroup() %>%
  group_by(MoreDefined) %>%
  summarize(mean = mean(total_curbs)) %>%
  mutate(MoreDefined = fct_reorder(MoreDefined, mean)) %>%
  ggplot(aes(MoreDefined, mean)) +
  geom_col() +
  ylab("Average Number of Bills in a Year for a State in a Given Selection System") +
  xlab("Selection System") +
  coord_flip() +
  theme_light()

ggsave("Average curbs by system.jpeg")

gavelCultureControlOnlyCurbs %>%
  group_by(Fullstate, MoreDefined, Year) %>%
  summarize(total_curbs = sum(curbing)) %>%
  filter(Year != 2007) %>%
  ungroup() %>%
  group_by(MoreDefined, Year) %>%
  summarize(mean = mean(total_curbs)) %>%
  ungroup(MoreDefined) %>%
  mutate(MoreDefined = fct_reorder(MoreDefined, mean),
          Year = as.Date(as.character(Year), format = "%Y")) %>%
  ggplot(aes(Year, mean, color = MoreDefined)) +
  geom_line() +
  ylab("Average Number of Bills for a State By Selection System") +
  xlab("Selection System") +
  theme_light() +
  scale_x_date() +
  ylim(c(0, 10)) +
  scale_color_discrete(name = "Selection System")

# ggsave("averages over time and selection.jpeg")

count_data %>%
  group_by(Fullstate, Professionalization, elected) %>%
  summarize(curbs = sum(curbs, na.rm = TRUE)) %>%
  ggplot(aes(Professionalization, curbs, color = as.factor(elected))) +
  geom_jitter() +
  scale_color_discrete(name = "Selection System",
                       breaks = c(0, 1),
                       labels = c("Appointed", "Elected")) +
  theme_light() +
  xlab("Level of Professionalization") +
  ylab("Number of Curbs by State")

ggsave("curbs by professionalization.jpeg")
```

```{r}
library(usmap)
library(maps)


all_states <- map_data("state")

capitals <- us.cities %>%
  filter(capital == 2) %>%
  left_join(gavelCultureControlOnlyCurbs, by = c("country.etc" = "State")) %>%
  group_by(country.etc, lat, long, MoreDefined) %>%
  count() %>%
  filter(!(country.etc %in% c("AK", "HI")))


capitals <- as_tibble(capitals)

str(capitals)

gavelCultureControlOnlyCurbs$Fullstate <- tolower(gavelCultureControlOnlyCurbs$Fullstate)


gavelCultureControlOnlyCurbs %>%
  group_by(Fullstate, MoreDefined) %>%
  count() %>%
  left_join(all_states, by = c("Fullstate" = "region")) %>%
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group, fill = MoreDefined, color = "white"), alpha = 0.3) +
  geom_point(data = capitals, aes(x = long, y = lat, size = n, color = "blue"), show.legend = FALSE) +
  theme_light() +
  xlab("") +
  ylab("") +
  theme_void() +
  labs(caption = "Larger Circles Indicate More Curbs") +
  scale_fill_discrete(name = "Selection System")


# ggsave("map of curbs.jpeg")
```


```{r}
gavelCultureControlOnlyCurbs %>%
  group_by(Fullstate, MoreDefined) %>%
  count() %>%
  left_join(all_states, by = c("Fullstate" = "region")) %>%
  ggplot() +
  geom_point(data = capitals, aes(x = long, y = lat, size = n, color = MoreDefined)) +
  borders("state") +
  theme_light() +
  xlab("") +
  ylab("") +
  theme_void() +
  labs(caption = "Larger Circles Indicate More Curbs",
       color = "Selection System",
       size = "Court Curbs") +
  scale_fill_discrete(name = "Selection System")

# ggsave("simple map of curbs.jpeg")
```

